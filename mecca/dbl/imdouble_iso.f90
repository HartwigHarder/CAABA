! ==============================================================================
! {%DBL}_box
! generated: {%TIMEDATE}
!
! this module is automaticly generated by imdouble utility
! contains: some maintenance routines for budgeting configurations (isotopes)
! level: smcl
!
! {$DBL_INFO} ! this is a template file for imdouble utility
!
! [Gromov, MPIC, 2007-2008]
! ==============================================================================

! - general doubling parameters (as conditional defines) -----------------------

#include "{%CMODEL}_dbl_parameters.inc"

! ------------------------------------------------------------------------------

! {$CONF_PARAM}

MODULE {%CMODEL}_{%DBL}

  USE messy_mecca_kpp     ! dp, ... nreact, nspec, ind_*, SPC_NAMES, EQN_TAGS
  USE {%CMODEL}_dbl_common

  IMPLICIT NONE

! treshold value: below it, species might stop to sink to the others 
! (but can receive still)
  REAL(dp), PARAMETER :: THRES = 1.0E-40_dp * 2.5047E+19_dp  
!                                ?          * mean cair

! -----------------------------------------------------------------------------

! here constants and doubled species indices are to be defined
! {$TRAC_DECL} [%{%TAG}_#%]

! -----------------------------------------------------------------------------
  
! no. of "rejected" species (under threshold)
  INTEGER             :: {%DBL}_NREJCT

! -----------------------------------------------------------------------------

  PRIVATE NKRSPEC, KRSIND

  PUBLIC {%DBL}_calctotals
  PUBLIC {%DBL}_correct2reg
  PUBLIC {%DBL}_correct2iso
  PUBLIC {%DBL}_resetPTs

! ==============================================================================

CONTAINS

! ==============================================================================

  SUBROUTINE {%DBL}_calctotals(C)

    IMPLICIT NONE

    REAL(dp), INTENT(INOUT) :: C(:)     ! operational vector of concentrations
    INTEGER  :: i

! here the number of {%ATOM} atoms only calculated, 
! according to each species composition

->>- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {>ATOM:C}
!   careful, TC is from regular!
    C(ind_ITC)   = SUM( C({%RDIND}(:,0))*REAL(QDCATOM(:),dp) )
    C(ind_I12TC) = SUM( C({%RDIND}(:,1))*REAL(QDCATOM(:),dp) + &
                        C({%RDIND}(:,2))*REAL(QDCATOM(:)-1,dp) )
    C(ind_I13TC) = SUM( C({%RDIND}(:,2)) )
-<<- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {<ATOM:C}
->>- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {>ATOM:O}
!   careful, TO is from regular!
    C(ind_{%ABBR}TO)   = SUM( C({%RDIND}(:,0))*REAL(QDOATOM(:),dp) )
    C(ind_{%ABBR}16TO) = SUM( C({%RDIND}(:,1))*REAL(QDOATOM(:),dp) + &
                        (C({%RDIND}(:,2)) + C({%RDIND}(:,3))) * &
                        REAL(QDOATOM(:)-1,dp) )
    C(ind_{%ABBR}17TO) = SUM( C({%RDIND}(:,2)) )
    C(ind_{%ABBR}18TO) = SUM( C({%RDIND}(:,3)) )
-<<- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {<ATOM:O}

  END SUBROUTINE {%DBL}_calctotals



! -----------------------------------------------------------------------------

! correction of total isotopologues budget to "regular" species budget

  SUBROUTINE {%DBL}_correct2reg(C)

    IMPLICIT NONE

    REAL(dp), INTENT(INOUT) :: C(:)     ! operational vector of concentrations
    INTEGER  :: i
    REAL(dp) :: total
   
#ifdef USE_KRSIND
! here is the ver. with corr. of only KIE-rel species to regular
->>- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {>ATOM:C}
    ! correcting only species related to KIE in this meccanism
    DO i = 1, NKRSPEC
      ! whole isotopic carbon
      total = C({%RDIND}(KRSIND(i),1)) + &
              C({%RDIND}(KRSIND(i),2))
      IF (total .LE. 0.0_dp) THEN
        C({%RDIND}(KRSIND(i),1)) = 0.0_dp
        C({%RDIND}(KRSIND(i),2)) = 0.0_dp
      ELSE
        C({%RDIND}(KRSIND(i),1)) = ( C({%RDIND}(KRSIND(i),1)) * & 
                                 C({%RDIND}(KRSIND(i),0)) ) / total
        C({%RDIND}(KRSIND(i),2)) = ( C({%RDIND}(KRSIND(i),2)) * &
                                 C({%RDIND}(KRSIND(i),0)) ) / total
      ENDIF
    ENDDO
-<<- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {<ATOM:C}
->>- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {>ATOM:O}
    ! correcting only species related to KIE in this meccanism
    DO i = 1, NKRSPEC
      ! whole isotopic oxygen
      total = C({%RDIND}(KRSIND(i),1)) + &
              C({%RDIND}(KRSIND(i),2)) + &
              C({%RDIND}(KRSIND(i),3)) 
      IF (total .LE. 0.0_dp) THEN
        C({%RDIND}(KRSIND(i),1)) = 0.0_dp
        C({%RDIND}(KRSIND(i),2)) = 0.0_dp
        C({%RDIND}(KRSIND(i),3)) = 0.0_dp
      ELSE
        C({%RDIND}(i,1)) = ( C({%RDIND}(KRSIND(i),1)) * &
                         C({%RDIND}(KRSIND(i),0)) ) / total
        C({%RDIND}(i,2)) = ( C({%RDIND}(KRSIND(i),2)) * &
                         C({%RDIND}(KRSIND(i),0)) ) / total
        C({%RDIND}(i,3)) = ( C({%RDIND}(KRSIND(i),3)) * &
                         C({%RDIND}(KRSIND(i),0)) ) / total
      ENDIF
    ENDDO
-<<- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {<ATOM:O}
#else
! here is the ver. with corr. of ALL species to regular
->>- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {>ATOM:C}
    DO i = 1, {%NDSPEC}
      ! whole isotopic carbon of selected species
      total = C({%RDIND}(i,1)) + &
              C({%RDIND}(i,2)) 
      IF (total .LE. 0.0_dp) THEN
        C({%RDIND}(i,1)) = 0.0_dp
        C({%RDIND}(i,2)) = 0.0_dp
      ELSE
        C({%RDIND}(i,1)) = ( C({%RDIND}(i,1)) * C({%RDIND}(i,0)) ) / total
        C({%RDIND}(i,2)) = ( C({%RDIND}(i,2)) * C({%RDIND}(i,0)) ) / total
      ENDIF
    ENDDO
-<<- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {<ATOM:C}
->>- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {>ATOM:O}
    DO i = 1, {%NDSPEC}
      ! whole isotopic oxygen of selected species
      total = C({%RDIND}(i,1)) + &
              C({%RDIND}(i,2)) + &
              C({%RDIND}(i,3)) 
      IF (total .LE. 0.0_dp) THEN
        C({%RDIND}(i,1)) = 0.0_dp
        C({%RDIND}(i,2)) = 0.0_dp
        C({%RDIND}(i,3)) = 0.0_dp
      ELSE
        C({%RDIND}(i,1)) = ( C({%RDIND}(i,0)) * C({%RDIND}(i,1)) ) / total
        C({%RDIND}(i,2)) = ( C({%RDIND}(i,0)) * C({%RDIND}(i,2)) ) / total
        C({%RDIND}(i,3)) = ( C({%RDIND}(i,0)) * C({%RDIND}(i,3)) ) / total
      ENDIF
    ENDDO
-<<- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {<ATOM:O}
#endif

  END SUBROUTINE {%DBL}_correct2reg



! -----------------------------------------------------------------------------
  
! correction of "regular" species budget to the total isotopologues budget

  SUBROUTINE {%DBL}_correct2iso(C)

    IMPLICIT NONE

    REAL(dp), INTENT(INOUT) :: C(:)     ! operational vector of concentrations
    INTEGER                 :: i

#ifdef USE_KRSIND
! here is the ver. with corr. of only KIE-rel species to regular
    DO i = 1, NKRSPEC
->>- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {>ATOM:C}
      C({%RDIND}(KRSIND(i),0)) = C({%RDIND}(KRSIND(i),1)) + &
                               C({%RDIND}(KRSIND(i),2))
-<<- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {<ATOM:C}
->>- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {>ATOM:O}
      C({%RDIND}(KRSIND(i),0)) = C({%RDIND}(KRSIND(i),1)) + &
                             ( C({%RDIND}(KRSIND(i),2)) + &
                               C({%RDIND}(KRSIND(i),3)) )
-<<- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {<ATOM:O}
    ENDDO
#endif
#ifndef USE_KRSIND
! here is the ver. with corr. of ALL species to regular
    DO i = 1, {%NDSPEC}
->>- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {>ATOM:C}
      C({%RDIND}(i,0)) = C({%RDIND}(i,1)) + &       
                       C({%RDIND}(i,2))
-<<- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {<ATOM:C}
->>- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {>ATOM:O}
      C({%RDIND}(i,0)) = C({%RDIND}(i,1)) + &
                     ( C({%RDIND}(i,2)) + &
                       C({%RDIND}(i,3)) )
-<<- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ {<ATOM:O}
    ENDDO
#endif

  END SUBROUTINE {%DBL}_correct2iso



! -----------------------------------------------------------------------------
  
  SUBROUTINE {%DBL}_resetPTs(C)

  ! production tracers initialization (reset) routine

    IMPLICIT NONE
    
    REAL(dp), INTENT(INOUT) :: C(:)     ! operational vector of concentrations
    
! {x$RESET_PTs}
! - currently disabled with use of DRPT{%ATOM}IND()

#ifdef USE_PT
    C(DRPT{%ATOM}IND(:)) = 0.0_dp    ! <-- boxmodel syntax
#endif

  END SUBROUTINE {%DBL}_resetPTs

! -----------------------------------------------------------------------------
  
END MODULE messy_mecca_{%DBL}

! *****************************************************************************

